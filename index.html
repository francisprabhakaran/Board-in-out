<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QR Board Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; background:#f4f4f4; margin:0; padding:10px; }
    h2 { margin-top:0 }
    input, button { padding:8px; margin:4px 0; width:100%; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { border:1px solid #999; padding:6px; font-size:14px; }
    th { background:#ddd; }
    .hidden { display:none }
    .admin { background:#ffe0e0; padding:10px; margin-top:10px; }
    .box { background:#fff; padding:10px; margin-top:10px; border-radius:6px; }
  </style>
</head>
<body>

<h2>QR Board Tracking</h2>

<!-- LOGIN -->
<div id="loginBox" class="box">
  <h3>Login</h3>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<!-- MAIN -->
<div id="mainBox" class="hidden">

  <div class="box">
    <b>Logged in as:</b> <span id="who"></span>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="admin hidden">
    <h3>Admin Panel</h3>
    <input id="newUser" placeholder="New username">
    <input id="newPass" placeholder="New password">
    <button onclick="addUser()">Add User</button>
    <br><br>
    <input id="delUser" placeholder="Username to delete">
    <button onclick="removeUser()">Remove User</button>
  </div>

  <!-- SCAN -->
  <div class="box">
    <h3>QR Scan (paste code)</h3>
    <input id="qrInput" placeholder="QR code value">
    <button onclick="scanIn()">IN</button>
    <button onclick="scanOut()">OUT</button>
  </div>

  <!-- STATUS -->
  <div class="box">
    <h3>Status (Live)</h3>
    <table>
      <thead>
        <tr><th>Board</th><th>Status</th><th>User</th><th>Time</th></tr>
      </thead>
      <tbody id="statusTable"></tbody>
    </table>
  </div>

  <!-- HISTORY -->
  <div class="box">
    <h3>History</h3>
    <table>
      <thead>
        <tr><th>Board</th><th>Action</th><th>User</th><th>Time</th></tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>
  </div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAVQUMUpgswjc32Um4hIYfeK",
  authDomain: "qr-board-tracking.firebaseapp.com",
  databaseURL: "https://qr-board-tracking-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "qr-board-tracking",
  storageBucket: "qr-board-tracking.appspot.com",
  messagingSenderId: "660301272276",
  appId: "1:660301272276:web:a78bbb57c78174e3471741"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= GLOBAL ================= */
let currentUser = "";
let isAdmin = false;

/* ================= LOGIN ================= */
function login(){
  const u = username.value.trim();
  const p = password.value.trim();

  if(u==="admin" && p==="francis.prabhakaran"){
    isAdmin = true;
    successLogin(u);
    return;
  }

  db.ref("users/"+u).once("value", s=>{
    if(s.exists() && s.val().password===p){
      successLogin(u);
    } else {
      alert("Invalid login");
    }
  });
}

function successLogin(u){
  currentUser = u;
  loginBox.classList.add("hidden");
  mainBox.classList.remove("hidden");
  who.innerText = u + (isAdmin ? " (ADMIN)" : "");
  if(isAdmin) adminPanel.classList.remove("hidden");
}

function logout(){
  location.reload();
}

/* ================= ADMIN ================= */
function addUser(){
  if(!isAdmin) return;
  db.ref("users/"+newUser.value).set({
    password: newPass.value
  });
  alert("User added");
}

function removeUser(){
  if(!isAdmin) return;
  db.ref("users/"+delUser.value).remove();
  alert("User removed");
}

/* ================= SCAN ================= */
function scanIn(){
  updateBoard("IN");
}
function scanOut(){
  updateBoard("OUT");
}

function updateBoard(action){
  const code = qrInput.value.trim();
  if(!code) return;

  const time = new Date().toLocaleString();

  db.ref("status/"+code).set({
    status: action,
    user: currentUser,
    time: time
  });

  db.ref("history").push({
    board: code,
    action: action,
    user: currentUser,
    time: time
  });

  qrInput.value="";
}

/* ================= LIVE STATUS ================= */
db.ref("status").on("value", snap=>{
  statusTable.innerHTML="";
  snap.forEach(s=>{
    const d = s.val();
    statusTable.innerHTML +=
      `<tr><td>${s.key}</td><td>${d.status}</td><td>${d.user}</td><td>${d.time}</td></tr>`;
  });
});

/* ================= HISTORY ================= */
db.ref("history").limitToLast(50).on("child_added", s=>{
  const d = s.val();
  historyTable.innerHTML =
    `<tr><td>${d.board}</td><td>${d.action}</td><td>${d.user}</td><td>${d.time}</td></tr>`
    + historyTable.innerHTML;
});
</script>
</body>
</html>
